import{i as L}from"./index-e90ad19a.js";import{_ as W,z as w,K,A as X,G as N,d as v,N as p,F as Y,r as c,o as k,c as O,b as _,f as t,t as n,H as Z,C as b,q as S,D as I,m as Q,n as $,p as ee,a as le}from"./index-87c3fdd7.js";import{I as oe}from"./index-ef97a484.js";const te=[400,400,280,120],T=[0,70,0,-27],ie=`${window.location.protocol}//${window.location.hostname}/pigeon`,R={父:0,我:0,母:1},re={components:{IconSearch:w,IconPlus:K,IconEdit:X,IconRefresh:oe},data(){return{data:null,updatedBloodline:null,editModal:!1,form:{id:null,country:null,year:null,province:null,code:null,name:null,bloodline:null,detail:null,source:"自育",breeder:null,subRingNumber:null,sex:"雄",ys:null,yan:null,lx:null,isGrade:null,pictureUrl:null,oid:null},isMe:!1,treeAncestors:null,options:{countryOptions:[],provinceOptions:[],breederOptions:[],yspzOptions:[],yanpzOptions:[],lxpzOptions:[]},file:{},searchModal:{visible:!1,columns:[{title:"足环",dataIndex:"ringNumber",align:"center",filterable:{filter:(o,e)=>{var i;return(i=e.ringNumber)==null?void 0:i.includes(o)},slotName:"ringNumber-filter",icon:()=>N(w)}},{title:"名称",dataIndex:"name",align:"center",filterable:{filter:(o,e)=>{var i;return(i=e.name)==null?void 0:i.includes(o)},slotName:"name-filter",icon:()=>N(w)}},{title:"血统",dataIndex:"bloodline",align:"center",filterable:{filter:(o,e)=>{var i;return(i=e.bloodline)==null?void 0:i.includes(o)},slotName:"bloodline-filter",icon:()=>N(w)}},{title:"操作",slotName:"operation",align:"center"}],data:null}}},async mounted(){await this.initData(),this.updatedBloodline=this.initBloodline()},methods:{async initData(){this.data=[await this.createTree(this.$route.params.id,"我",0)]},async createTree(o,e,i){if(i<4){let a={name:e,value:{pigeon:{id:o}},label:{height:te[i],offset:[0,e==="母"?-T[i]:T[i]],backgroundColor:o?"#FFE8FB":"#ffffff"},children:[]};o&&await v({method:"GET",url:`pigeon/${o}`,message:"正在获取鸽子数据"}).then(h=>{h.data.code===200&&(a.value=JSON.parse(JSON.stringify(h.data.data)))});const l=await this.createTree(a.value.pigeon.fid,"父",i+1);l&&a.children.push(l);const m=await this.createTree(a.value.pigeon.mid,"母",i+1);return m&&a.children.push(m),a}},async handleUpdateTree(o,e,i){const a=this.treeAncestors[e].name;if(e<this.treeAncestors.length-1){await this.handleUpdateTree(o[R[a]].children,e+1,i);return}o[R[a]]=await this.createTree(i,a,e-1),this.updatedBloodline()},getOption(){return{title:{text:"编辑鸽子",subtext:this.$route.params.id?"修改":"新增"},tooltip:{trigger:"none",triggerOn:"none"},series:[{type:"tree",orient:"LR",top:"0%",left:"12%",bottom:"0%",right:"12%",edgeShape:"polyline",symbol:"none",initialTreeDepth:-1,expandAndCollapse:!1,roam:"move",label:{borderWidth:10,padding:10,borderColor:"#eee",backgroundColor:"#fff",width:200,overflow:"truncate",formatter:o=>{const e=o.value.pigeon,i=o.value.pigeonInfo;return[`{title|${o.name}}`,"{hr|}",e!=null&&e.ringNumber?`{text|${e.ringNumber}}`:"{empty|}","{hr|}",e!=null&&e.name?`{text|${e.name}}`:"{empty|}",`{text|${(e==null?void 0:e.sex)??""} ${(e==null?void 0:e.ys)??""} ${(e==null?void 0:e.yan)??""}}`,e!=null&&e.bloodline?`{text|${e.bloodline}}`:"{empty|}",i!=null&&i.detail?`{text|${i.detail}}`:"{empty|}"].join(`
`)},rich:{title:{align:"center",fontSize:15,height:30},text:{height:30,fontSize:15},empty:{height:0},hr:{borderColor:"#777",width:"100%",borderWidth:.5,height:0}}},data:this.data}]}},initBloodline(){const o={renderer:"canvas",useDirtyRect:!0,locale:"ZH"},e=L(this.$refs.bloodline,null,o);return e.on("click",i=>{var l,m,h,f;let a=i.treeAncestors.length;if(a>2&&!i.treeAncestors[a-2].value.pigeon.id){p.warning("子代暂无数据，无法编辑");return}if(this.isMe=i.name==="我",i.value.pigeon.id){const r=i.value.pigeon,u=i.value.pigeonInfo,d=(l=r==null?void 0:r.ringNumber)==null?void 0:l.split("-");this.form={id:r.id??null,country:d?d[0]:null,year:d?d[1]:null,province:d?d[2]:null,code:d?d[3]:null,name:(r==null?void 0:r.name)??null,bloodline:(r==null?void 0:r.bloodline)??null,detail:(u==null?void 0:u.detail)??null,source:(u==null?void 0:u.source)??!0?"自育":"引进",breeder:(u==null?void 0:u.source)??!0?null:u.source,subRingNumber:(u==null?void 0:u.subRingNumber)??null,sex:(r==null?void 0:r.sex)??null,ys:(r==null?void 0:r.ys)??null,yan:(r==null?void 0:r.yan)??null,lx:(r==null?void 0:r.lx)??null,isGrade:(r==null?void 0:r.isGrade)??null,pictureUrl:(r==null?void 0:r.pictureUrl)??null},this.file={url:r!=null&&r.pictureUrl?`${ie}/${r.pictureUrl}`:null,name:(r==null?void 0:r.pictureUrl)??null}}this.form.oid=((f=(h=(m=i.treeAncestors[a-2])==null?void 0:m.value)==null?void 0:h.pigeon)==null?void 0:f.id)??null,this.form.sex=i.name==="母"?"雌":"雄",this.treeAncestors=i.treeAncestors,this.editModal=!0}),e.setOption(this.getOption()),()=>e.setOption(this.getOption())},resetForm(){this.form={id:null,country:null,year:null,province:null,code:null,name:null,bloodline:null,detail:null,source:"自育",breeder:null,subRingNumber:null,sex:"雄",ys:null,yan:null,lx:null,isGrade:null,pictureUrl:null,oid:null},this.isMe=!1,this.treeAncestors=null,this.file={}},handleCancel(){this.$store.state.isPending?p.error("请求已发送，取消失败"):p.info("已取消"),this.resetForm()},handleSearchCancel(){this.$store.state.isPending?p.error("请求已发送，取消失败"):p.info("已取消")},handleBeforeOpen(){let o=!1;for(let e in this.options)if(this.options[e].length>0){o=!0;break}o||v({method:"GET",url:"xxpz"}).then(e=>{e.data.code===200&&e.data.data.forEach(i=>{if(this.options[`${i.type}Options`]){const a=i.name.split("/");this.options[`${i.type}Options`].push({label:a[1]?a[0]+a[1]:a[0],value:a[1]?a[1]:a[0]})}})})},resetTable(){this.$refs.table.clearSorters(),this.$refs.table.clearFilters(),p.success("已清空筛选")},onChange(o,e){this.file=e},customRequest(o){const{onProgress:e,onError:i,onSuccess:a,fileItem:l,name:m}=o,h=new FormData;h.append(m||"file",l.file),v({method:"POST",url:"pigeon/picture",data:h,message:"正在上传图片",onUploadProgress:f=>{const r=f.loaded/f.total;e(r,f)}}).then(f=>{f.data.code===200?(a(f),this.form.pictureUrl=f.data.data,p.success(f.data.message)):(i(f),this.file={},p.error(f.data.message))}).catch(f=>{i(f),this.file={},p.error("服务器发生错误，上传超时")})},async handleEditPigeon(){const o=this.form;if(!Y(()=>{if(!o.country||!o.year||!o.province||!o.code||!o.sex)return p.warning("必填信息为空"),!1;if(o.source==="引进"&&!o.breeder)return p.warning("引进选项未找到作育者"),!1},"正在验证数据"))return!1;const e={pigeon:{id:o.id,pictureUrl:o.pictureUrl,ringNumber:[o.country,o.year,o.province,o.code].join("-"),name:o.name,bloodline:o.bloodline,sex:o.sex,yan:o.yan,ys:o.ys,lx:o.lx,isGrade:o.isGrade},pigeonInfo:{source:o.source==="自育"?"自育":o.breeder,subRingNumber:o.subRingNumber,detail:o.detail},oid:this.form.oid};return await v({method:"POST",url:"pigeon",data:e,message:"正在上传鸽子信息"}).then(i=>{if(i.data.code===200){p.success(i.data.message);const a=i.data.data;return this.handleUpdateTree(this.data,1,a),this.resetForm(),!0}else if(i.data.code===414)return p.warning(`足环${i.data.message}，如需添加血亲关系请使用“搜索”`),!1})},handleSearchModalOpen(){const o=[];this.treeAncestors.forEach(e=>{var a,l;const i=(l=(a=e.value)==null?void 0:a.pigeon)==null?void 0:l.id;i&&o.push(i)}),v({method:"POST",url:`pigeon/parent/${this.form.sex}`,data:o,message:"正在获取父代信息"}).then(e=>{e.data.code===200&&(this.searchModal={...this.searchModal,visible:!0,data:e.data.data})})},handleSelect(o){this.form.oid?(console.log(o),v({method:"PATCH",url:"pigeon/relate",data:{id:o.id,sex:o.sex,ringNumber:o.ringNumber,oid:this.form.oid}}).then(e=>{e.data.code===200?(this.handleUpdateTree(this.data,1,o.id),this.closeModal(),p.success(e.data.message)):p.error(e.data.message)})):(this.handleUpdateTree(this.data,1,o.id),this.closeModal())},closeModal(){this.searchModal.visible=!1,this.searchModal.data=null,this.editModal=!1,this.resetForm()}}},ne=o=>(ee("data-v-73e7bd15"),o=o(),le(),o),se={ref:"bloodline",class:"bloodline"},ae={key:0,class:"arco-upload-list-picture custom-upload-avatar"},de=["src"],ue={class:"arco-upload-list-picture-mask"},ce={key:1,class:"arco-upload-picture-card"},me={class:"arco-upload-picture-card-text"},fe=ne(()=>_("div",{style:{"margin-top":"10px","font-weight":"600"}},"上传",-1)),pe={class:"custom-filter"},he={class:"custom-filter-footer"},be={class:"custom-filter"},_e={class:"custom-filter-footer"},ye={class:"custom-filter"},ge={class:"custom-filter-footer"};function ve(o,e,i,a,l,m){const h=c("a-divider"),f=c("IconSearch"),r=c("a-button"),u=c("a-select"),d=c("a-form-item"),M=c("a-col"),B=c("a-year-picker"),y=c("a-input"),P=c("a-row"),A=c("a-textarea"),q=c("a-radio-group"),G=c("IconEdit"),F=c("a-progress"),E=c("IconPlus"),D=c("a-upload"),j=c("a-form"),z=c("a-modal"),H=c("IconRefresh"),U=c("a-space"),J=c("a-table");return k(),O(Z,null,[_("div",se,null,512),t(z,{visible:l.editModal,"onUpdate:visible":e[15]||(e[15]=s=>l.editModal=s),title:"编辑鸽子",width:800,onBeforeOk:m.handleEditPigeon,onCancel:m.handleCancel,onBeforeOpen:m.handleBeforeOpen},{default:n(()=>[t(j,{model:l.form},{default:n(()=>[t(h,{size:2,style:{"border-bottom-style":"dotted"},orientation:"left"},{default:n(()=>[b("通过搜索输入")]),_:1}),t(r,{type:"primary",onClick:m.handleSearchModalOpen},{default:n(()=>[t(f),b(" 搜索 ")]),_:1},8,["onClick"]),t(h,{size:2,style:{"border-bottom-style":"dotted"},orientation:"left"},{default:n(()=>[b("完成信息填写")]),_:1}),t(d,{label:"足环",extra:"由“-”组合成足环","content-flex":!1,"merge-props":!1,required:""},{default:n(()=>[t(P,{wrap:!1,gutter:1},{default:n(()=>[t(M,{flex:"1"},{default:n(()=>[t(d,{field:"country","validate-trigger":"blur","hide-asterisk":!0,required:""},{default:n(()=>[t(u,{modelValue:l.form.country,"onUpdate:modelValue":e[0]||(e[0]=s=>l.form.country=s),modelModifiers:{lazy:!0},options:l.options.countryOptions,placeholder:"-国家-","allow-search":""},null,8,["modelValue","options"])]),_:1})]),_:1}),t(M,{flex:"1"},{default:n(()=>[t(d,{field:"year","validate-trigger":"blur","hide-asterisk":!0,required:""},{default:n(()=>[t(B,{modelValue:l.form.year,"onUpdate:modelValue":e[1]||(e[1]=s=>l.form.year=s),modelModifiers:{lazy:!0}},null,8,["modelValue"])]),_:1})]),_:1}),t(M,{flex:"1"},{default:n(()=>[t(d,{field:"province","validate-trigger":"blur","hide-asterisk":!0,required:""},{default:n(()=>[t(u,{modelValue:l.form.province,"onUpdate:modelValue":e[2]||(e[2]=s=>l.form.province=s),modelModifiers:{lazy:!0},options:l.options.provinceOptions,placeholder:"-省份-","allow-search":""},null,8,["modelValue","options"])]),_:1})]),_:1}),t(M,{flex:"1"},{default:n(()=>[t(d,{field:"code","validate-trigger":"blur","hide-asterisk":!0,required:""},{default:n(()=>[t(y,{modelValue:l.form.code,"onUpdate:modelValue":e[3]||(e[3]=s=>l.form.code=s),modelModifiers:{lazy:!0},placeholder:"编号"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1}),t(d,{label:"名称",field:"name"},{default:n(()=>[t(y,{modelValue:l.form.name,"onUpdate:modelValue":e[4]||(e[4]=s=>l.form.name=s),modelModifiers:{lazy:!0},placeholder:"名称"},null,8,["modelValue"])]),_:1}),t(d,{label:"血统",field:"bloodline"},{default:n(()=>[t(y,{modelValue:l.form.bloodline,"onUpdate:modelValue":e[5]||(e[5]=s=>l.form.bloodline=s),modelModifiers:{lazy:!0},placeholder:"血统"},null,8,["modelValue"])]),_:1}),t(d,{label:"描述",field:"detail",extra:"允许换行输入"},{default:n(()=>[t(A,{modelValue:l.form.detail,"onUpdate:modelValue":e[6]||(e[6]=s=>l.form.detail=s),modelModifiers:{lazy:!0},"auto-size":""},null,8,["modelValue"])]),_:1}),t(d,{label:"来源",field:"source"},{default:n(()=>[t(q,{modelValue:l.form.source,"onUpdate:modelValue":e[7]||(e[7]=s=>l.form.source=s),modelModifiers:{lazy:!0},options:["自育","引进"]},null,8,["modelValue"])]),_:1}),l.form.source==="引进"?(k(),S(d,{key:0,label:"作育者",field:"breeder",required:""},{default:n(()=>[t(u,{modelValue:l.form.breeder,"onUpdate:modelValue":e[8]||(e[8]=s=>l.form.breeder=s),modelModifiers:{lazy:!0},options:l.options.breederOptions,placeholder:"-作育者-","allow-search":""},null,8,["modelValue","options"])]),_:1})):I("",!0),t(d,{label:"副足环",field:"subRingNumber"},{default:n(()=>[t(y,{modelValue:l.form.subRingNumber,"onUpdate:modelValue":e[9]||(e[9]=s=>l.form.subRingNumber=s),placeholder:"副足环"},null,8,["modelValue"])]),_:1}),t(d,{label:"性别",field:"sex",required:""},{default:n(()=>[t(u,{modelValue:l.form.sex,"onUpdate:modelValue":e[10]||(e[10]=s=>l.form.sex=s),modelModifiers:{lazy:!0},options:["雄","雌"],placeholder:"-性别-",disabled:!l.isMe||!!l.form.id},null,8,["modelValue","disabled"])]),_:1}),t(d,{label:"羽色",field:"ys"},{default:n(()=>[t(u,{modelValue:l.form.ys,"onUpdate:modelValue":e[11]||(e[11]=s=>l.form.ys=s),modelModifiers:{lazy:!0},options:l.options.yspzOptions,placeholder:"-羽色-","allow-search":""},null,8,["modelValue","options"])]),_:1}),t(d,{label:"眼砂",field:"yan"},{default:n(()=>[t(u,{modelValue:l.form.yan,"onUpdate:modelValue":e[12]||(e[12]=s=>l.form.yan=s),modelModifiers:{lazy:!0},options:l.options.yanpzOptions,placeholder:"-眼砂-","allow-search":""},null,8,["modelValue","options"])]),_:1}),t(d,{label:"类型",field:"lx"},{default:n(()=>[t(u,{modelValue:l.form.lx,"onUpdate:modelValue":e[13]||(e[13]=s=>l.form.lx=s),modelModifiers:{lazy:!0},options:l.options.lxpzOptions,placeholder:"-类型-","allow-search":""},null,8,["modelValue","options"])]),_:1}),t(d,{label:"赛绩鸽",field:"isGrade"},{default:n(()=>[t(u,{modelValue:l.form.isGrade,"onUpdate:modelValue":e[14]||(e[14]=s=>l.form.isGrade=s),modelModifiers:{lazy:!0},options:["否","是"],placeholder:"-赛绩鸽-"},null,8,["modelValue"])]),_:1}),t(d,{label:"鸽子照片",field:"pictureUrl"},{default:n(()=>[t(D,{action:"pigeon/picture",fileList:l.file?[l.file]:[],"show-file-list":!1,onChange:m.onChange,"custom-request":m.customRequest,accept:"image/jpeg, image/png, image/gif, image/tiff"},{"upload-button":n(()=>[_("div",{class:$(`arco-upload-list-item${l.file&&l.file.status==="error"?" arco-upload-list-item-error":""}`)},[l.file&&l.file.url?(k(),O("div",ae,[_("img",{src:l.file.url,alt:"鸽子照片"},null,8,de),_("div",ue,[t(G)]),l.file.status==="uploading"&&l.file.percent<100?(k(),S(F,{key:0,percent:l.file.percent,type:"circle",size:"mini",style:Q({position:"absolute",left:"50%",top:"50%",transform:"translateX(-50%) translateY(-50%)"})},null,8,["percent","style"])):I("",!0)])):(k(),O("div",ce,[_("div",me,[t(E),fe])]))],2)]),_:1},8,["fileList","onChange","custom-request"])]),_:1})]),_:1},8,["model"])]),_:1},8,["visible","onBeforeOk","onCancel","onBeforeOpen"]),t(z,{visible:l.searchModal.visible,"onUpdate:visible":e[17]||(e[17]=s=>l.searchModal.visible=s),title:"选择鸽子并绑定血亲关系",width:800,footer:!1,onCancel:m.handleSearchCancel},{default:n(()=>[t(r,{type:"primary",status:"success",onClick:e[16]||(e[16]=s=>m.resetTable())},{default:n(()=>[t(H,{style:{color:"#ffffff"}}),b(" 清空筛选 ")]),_:1}),t(h,{size:2,style:{"border-bottom-style":"dotted"},orientation:"left"},{default:n(()=>[b("鸽子信息")]),_:1}),t(J,{ref:"table",columns:l.searchModal.columns,data:l.searchModal.data,size:"small",scroll:{y:400}},{operation:n(({record:s})=>[t(r,{type:"outline",status:"success",onClick:g=>m.handleSelect(s)},{default:n(()=>[b(" 选择 ")]),_:2},1032,["onClick"])]),"ringNumber-filter":n(({filterValue:s,setFilterValue:g,handleFilterConfirm:x,handleFilterReset:V})=>[_("div",pe,[t(U,{direction:"vertical"},{default:n(()=>[t(y,{"model-value":s[0],onInput:C=>g([C])},null,8,["model-value","onInput"]),_("div",he,[t(r,{onClick:x},{default:n(()=>[b("搜索")]),_:2},1032,["onClick"]),t(r,{onClick:V},{default:n(()=>[b("重置")]),_:2},1032,["onClick"])])]),_:2},1024)])]),"name-filter":n(({filterValue:s,setFilterValue:g,handleFilterConfirm:x,handleFilterReset:V})=>[_("div",be,[t(U,{direction:"vertical"},{default:n(()=>[t(y,{"model-value":s[0],onInput:C=>g([C])},null,8,["model-value","onInput"]),_("div",_e,[t(r,{onClick:x},{default:n(()=>[b("搜索")]),_:2},1032,["onClick"]),t(r,{onClick:V},{default:n(()=>[b("重置")]),_:2},1032,["onClick"])])]),_:2},1024)])]),"bloodline-filter":n(({filterValue:s,setFilterValue:g,handleFilterConfirm:x,handleFilterReset:V})=>[_("div",ye,[t(U,{direction:"vertical"},{default:n(()=>[t(y,{"model-value":s[0],onInput:C=>g([C])},null,8,["model-value","onInput"]),_("div",ge,[t(r,{onClick:x},{default:n(()=>[b("搜索")]),_:2},1032,["onClick"]),t(r,{onClick:V},{default:n(()=>[b("重置")]),_:2},1032,["onClick"])])]),_:2},1024)])]),_:1},8,["columns","data"])]),_:1},8,["visible","onCancel"])],64)}const ke=W(re,[["render",ve],["__scopeId","data-v-73e7bd15"]]);export{ke as default};
